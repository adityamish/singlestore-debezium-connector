name: Release

on:
  push:
    tags: "v*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Docker Login
      # You may pin to the exact commit or the version.
      # uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d
      uses: docker/login-action@v3.0.0
      with:
        # Username used to log against the Docker registry
        username: ${{ secrets.DOCKER_USERNAME }}
        # Password or personal access token used to log against the Docker registry
        password: ${{ secrets.DOCKER_PASSWORD }}
    - name: Import GPG key
      run: |
        openssl enc -d -aes-256-cbc -K ${{ secrets.ENCRYPTION_KEY }} -iv ${{ secrets.ENCRYPTION_IV }} -in .github/workflows/secring.asc.enc -out .github/workflows/secring.asc
        gpg --import .github/workflows/secring.asc        
    - name: Copy Maven Settings
      run: |
        mkdir -p ~/.m2
        cp .github/workflows/settings.xml ~/.m2/settings.xml
    - name: Release to Maven Central 
      run: mvn -B clean deploy --file pom.xml -P assembly
    - name: Release Plugin Archive
      uses: softprops/action-gh-release@v1
      with:
        files: target/singlestore-debezium-connector-*-plugin.tar.gz
